<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Caromê</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 250px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        aside h1 {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            color: #ecf0f1;
        }

        .menu-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #34495e;
        }

        .menu-item.active {
            background: #803D16;
            font-weight: bold;
        }

        .logout-btn {
            margin-top: auto;
            background: #c0392b;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .logout-btn:hover {
            background: #a93226;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background: #803D16;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #602d10;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        /* Product List Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: grab;
            position: relative;
        }

        .product-card:active {
            cursor: grabbing;
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .product-card h3 {
            margin: 0 0 5px;
            font-size: 18px;
        }

        .product-card .price {
            color: #803D16;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 5px 10px;
            font-size: 12px;
            flex: 1;
        }

        .btn-edit {
            background: #007bff;
        }

        .btn-delete {
            background: #dc3545;
        }

        .img-preview-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .img-preview-item {
            position: relative;
        }

        .img-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .btn-remove-img {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* Banner Visual Editor */
        .banner-editor {
            width: 100%;
            height: 300px;
            background: #eee;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 10px;
            cursor: move;
            border: 2px dashed #ccc;
        }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 14px;
            pointer-events: none;
        }

        /* Login Screen Override */
        #loginSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f4f4f4;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #loginSection .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        /* Customization Grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .color-item input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        /* Mobile Responsiveness */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 2000;
            background: #803D16;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1400;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            aside {
                position: fixed;
                top: 0;
                left: -250px;
                height: 100%;
                z-index: 1500;
                transition: left 0.3s ease;
            }

            aside.open {
                left: 0;
            }

            .sidebar-overlay.active {
                display: block;
            }

            main {
                padding: 60px 20px 20px 20px;
                /* Add top padding for hamburger */
            }
        }
    </style>
</head>

<body>
    <!-- Login Section -->
    <div id="loginSection">
        <div class="login-box">
            <h2 style="text-align: center;">Login Admin</h2>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Senha</label>
                <input type="password" id="password" required>
            </div>
            <button id="loginBtn" style="width: 100%;">Entrar</button>
            <div id="loginStatus" class="status" style="text-align: center;"></div>
        </div>
    </div>

    <!-- Admin Layout (Hidden by default) -->
    <div id="adminLayout" class="hidden" style="display: flex; width: 100%;">
        <button id="mobileMenuBtn" class="mobile-menu-btn">☰</button>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        <aside id="sidebar">
            <h1>Caromê Admin</h1>
            <div class="menu-item active" onclick="showSection('products')">Produtos</div>
            <div class="menu-item" onclick="showSection('banner')">Banner</div>
            <div class="menu-item" onclick="showSection('customization')">Personalização</div>
            <button id="logoutBtn" class="logout-btn">Sair</button>
        </aside>

        <main>
            <!-- Products Section -->
            <div id="productsSection" class="container">
                <!-- List View -->
                <div id="productsListView">
                    <h2>
                        Produtos
                        <button onclick="startNewProduct()" style="width: auto; margin: 0; font-size: 14px;">+ Novo
                            Produto</button>
                    </h2>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Arraste os itens para reordenar.</p>
                    <div id="productList" class="product-grid">Carregando...</div>
                </div>

                <!-- Form View (Hidden) -->
                <div id="productFormView" class="hidden">
                    <h2 id="formTitle">Cadastrar Produto</h2>
                    <form id="productForm">
                        <input type="hidden" id="originalId"> <!-- To track edits -->

                        <div class="form-group">
                            <label for="id">ID (slug, ex: painel-luz)</label>
                            <input type="text" id="id" required>
                        </div>
                        <div class="form-group">
                            <label for="title">Nome do Produto</label>
                            <input type="text" id="title" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Preço (ex: R$ 100,00)</label>
                            <input type="text" id="price" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Descrição</label>
                            <textarea id="description" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="features">Características (separadas por |)</label>
                            <input type="text" id="features" placeholder="Ex: Algodão | 80cm x 40cm">
                        </div>
                        <div class="form-group">
                            <label for="autoplay_interval">Intervalo do Carrossel (ms)</label>
                            <input type="number" id="autoplay_interval" placeholder="2000" value="2000">
                            <small>Tempo em milissegundos para troca automática de imagens (0 para desativar).</small>
                        </div>
                        <div class="form-group">
                            <label for="image">Imagens</label>
                            <input type="file" id="image" accept="image/*" multiple>
                            <small>Selecione uma ou mais imagens. A primeira será a principal.</small>
                            <div id="currentImages" class="img-preview-container"></div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button type="submit" id="submitBtn">Salvar Produto</button>
                            <button type="button" id="cancelBtn" style="background: #ccc;"
                                onclick="hideProductForm()">Cancelar</button>
                        </div>
                        <div id="status" class="status"></div>
                    </form>
                </div>
            </div>

            <!-- Banner Section -->
            <div id="bannerSection" class="container hidden">
                <h2>Configuração do Banner</h2>
                <form id="bannerForm">
                    <div class="form-group">
                        <label for="bannerImage">Imagem do Banner</label>
                        <input type="file" id="bannerImage" accept="image/*">
                    </div>

                    <div class="form-group">
                        <label>Ajuste Visual (Arraste para mover, use o slider para zoom)</label>
                        <div id="bannerEditor" class="banner-editor">
                            <div id="bannerPreviewDiv"
                                style="width: 100%; height: 100%; background-repeat: no-repeat; background-position: center; background-size: cover;">
                            </div>
                            <div class="banner-overlay">Arraste para ajustar</div>
                        </div>

                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <label for="bannerZoom" style="margin:0;">Zoom:</label>
                            <input type="range" id="bannerZoom" min="100" max="250" value="100" style="flex: 1;">
                            <span id="zoomDisplay">100%</span>
                        </div>

                        <input type="hidden" id="bannerPosition"> <!-- Stores "x% y% / size%" or just "x% y%" -->
                        <small id="posDisplay" style="display: block; margin-top: 5px; color: #666;">Config: center /
                            cover</small>
                    </div>

                    <button type="submit" id="saveBannerBtn">Salvar Banner</button>
                    <div id="bannerStatus" class="status"></div>
                </form>
            </div>

            <!-- Customization Section -->
            <div id="customizationSection" class="container hidden">
                <h2>Personalização do Site</h2>
                <form id="customizationForm">
                    <h3>Cores</h3>
                    <div class="color-grid">
                        <div class="color-item">
                            <input type="color" id="color-bg" value="#F2E5D5">
                            <label>Fundo Principal</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-text" value="#803D16">
                            <label>Texto Principal</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-accent" value="#A0845C">
                            <label>Detalhes (Accent)</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-header-bg" value="#F5F1EB">
                            <label>Fundo Cabeçalho</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-card-bg" value="#F7F7F7">
                            <label>Fundo Cartão</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-btn-bg" value="#803D16">
                            <label>Botão Fundo</label>
                        </div>
                        <div class="color-item">
                            <input type="color" id="color-btn-text" value="#F2E5D5">
                            <label>Botão Texto</label>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Textos</h3>
                    <div class="form-group">
                        <label for="text-hero">Título Principal (Hero)</label>
                        <input type="text" id="text-hero" placeholder="Onde o fio se transforma em arte">
                    </div>
                    <div class="form-group">
                        <label for="text-about">Intro "Quem Somos"</label>
                        <textarea id="text-about" rows="3" placeholder="Cada peça é criada com amor..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="text-contact">Subtítulo Contato</label>
                        <input type="text" id="text-contact" placeholder="Fale conosco para encomendas e dúvidas.">
                    </div>

                    <button type="submit" id="saveCustomizationBtn">Salvar Personalização</button>
                    <div id="customizationStatus" class="status"></div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { supabase } from './src/supabaseClient.js'

        // Elements
        const loginSection = document.getElementById('loginSection');
        const adminLayout = document.getElementById('adminLayout');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginStatus = document.getElementById('loginStatus');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Sections
        const sections = {
            products: document.getElementById('productsSection'),
            banner: document.getElementById('bannerSection'),
            customization: document.getElementById('customizationSection')
        };

        // Product Views
        const productsListView = document.getElementById('productsListView');
        const productFormView = document.getElementById('productFormView');

        // Product Form Elements
        const productForm = document.getElementById('productForm');
        const productList = document.getElementById('productList');
        const status = document.getElementById('status');
        const submitBtn = document.getElementById('submitBtn');
        const formTitle = document.getElementById('formTitle');
        const currentImagesDiv = document.getElementById('currentImages');

        // Banner Elements
        const bannerForm = document.getElementById('bannerForm');
        const bannerStatus = document.getElementById('bannerStatus');
        const saveBannerBtn = document.getElementById('saveBannerBtn');
        const bannerImageInput = document.getElementById('bannerImage');
        const bannerPositionInput = document.getElementById('bannerPosition');
        const bannerEditor = document.getElementById('bannerEditor');
        const posDisplay = document.getElementById('posDisplay');
        const bannerPreviewDiv = document.getElementById('bannerPreviewDiv');
        const bannerZoomInput = document.getElementById('bannerZoom');
        const zoomDisplay = document.getElementById('zoomDisplay');

        // Customization Elements
        const customizationForm = document.getElementById('customizationForm');
        const customizationStatus = document.getElementById('customizationStatus');
        const saveCustomizationBtn = document.getElementById('saveCustomizationBtn');

        // State
        let currentImagesList = [];
        window.productsData = [];
        let bannerDrag = { active: false, initialX: 50, initialY: 50 }; // percentages

        // --- Navigation ---
        window.showSection = (sectionName) => {
            Object.values(sections).forEach(el => el.classList.add('hidden'));
            sections[sectionName].classList.remove('hidden');

            document.querySelectorAll('.menu-item').forEach(el => {
                el.classList.remove('active');
                if (el.textContent.toLowerCase().includes(sectionName === 'products' ? 'produtos' : (sectionName === 'banner' ? 'banner' : 'personalização'))) {
                    el.classList.add('active');
                }
            });

            if (window.innerWidth <= 768) {
                toggleSidebar(false);
            }

            if (sectionName === 'products') {
                hideProductForm(); // Ensure we start at list
            }
        };

        window.showProductForm = () => {
            productsListView.classList.add('hidden');
            productFormView.classList.remove('hidden');
        };

        window.startNewProduct = () => {
            resetForm();
            showProductForm();
        };

        window.hideProductForm = () => {
            productFormView.classList.add('hidden');
            productsListView.classList.remove('hidden');
            resetForm();
        };

        // --- Auth Logic ---
        async function checkUser() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                showAdmin();
                loadProducts();
                loadBannerConfig();
                loadCustomization();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            adminLayout.classList.add('hidden');
        }

        function showAdmin() {
            loginSection.classList.add('hidden');
            adminLayout.classList.remove('hidden');
        }

        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginStatus.textContent = 'Entrando...';

            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                loginStatus.textContent = 'Erro: ' + error.message;
                loginStatus.style.color = 'red';
            } else {
                loginStatus.textContent = '';
                showAdmin();
                loadProducts();
                loadBannerConfig();
                loadCustomization();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            showLogin();
        });

        // --- Customization Logic ---
        async function loadCustomization() {
            try {
                const { data } = supabase.storage
                    .from('product-images')
                    .getPublicUrl('theme.json');

                if (data && data.publicUrl) {
                    const response = await fetch(data.publicUrl + '?t=' + new Date().getTime());
                    if (response.ok) {
                        const theme = await response.json();

                        // Colors
                        if (theme.colors) {
                            if (theme.colors['--bg-color']) document.getElementById('color-bg').value = theme.colors['--bg-color'];
                            if (theme.colors['--text-color']) document.getElementById('color-text').value = theme.colors['--text-color'];
                            if (theme.colors['--accent-color']) document.getElementById('color-accent').value = theme.colors['--accent-color'];
                            if (theme.colors['--header-bg']) document.getElementById('color-header-bg').value = theme.colors['--header-bg'];
                            if (theme.colors['--card-bg']) document.getElementById('color-card-bg').value = theme.colors['--card-bg'];
                            if (theme.colors['--btn-bg']) document.getElementById('color-btn-bg').value = theme.colors['--btn-bg'];
                            if (theme.colors['--btn-text']) document.getElementById('color-btn-text').value = theme.colors['--btn-text'];
                        }

                        // Texts
                        if (theme.texts) {
                            document.getElementById('text-hero').value = theme.texts.heroTitle || '';
                            document.getElementById('text-about').value = theme.texts.aboutIntro || '';
                            document.getElementById('text-contact').value = theme.texts.contactSubtitle || '';
                        }
                    }
                }
            } catch (e) {
                console.log('No theme found or error loading', e);
            }
        }

        customizationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveCustomizationBtn.disabled = true;
            saveCustomizationBtn.textContent = 'Salvando...';
            customizationStatus.textContent = '';

            const theme = {
                colors: {
                    '--bg-color': document.getElementById('color-bg').value,
                    '--text-color': document.getElementById('color-text').value,
                    '--accent-color': document.getElementById('color-accent').value,
                    '--header-bg': document.getElementById('color-header-bg').value,
                    '--card-bg': document.getElementById('color-card-bg').value,
                    '--btn-bg': document.getElementById('color-btn-bg').value,
                    '--btn-text': document.getElementById('color-btn-text').value,
                },
                texts: {
                    heroTitle: document.getElementById('text-hero').value,
                    aboutIntro: document.getElementById('text-about').value,
                    contactSubtitle: document.getElementById('text-contact').value
                }
            };

            try {
                const blob = new Blob([JSON.stringify(theme)], { type: 'application/json' });
                const { error } = await supabase.storage
                    .from('product-images')
                    .upload('theme.json', blob, { upsert: true });

                if (error) throw error;

                customizationStatus.textContent = 'Personalização salva com sucesso!';
                customizationStatus.style.color = 'green';
            } catch (err) {
                console.error(err);
                customizationStatus.textContent = 'Erro ao salvar: ' + err.message;
                customizationStatus.style.color = 'red';
            } finally {
                saveCustomizationBtn.disabled = false;
                saveCustomizationBtn.textContent = 'Salvar Personalização';
            }
        });


        // --- Banner Logic (Visual Editor) ---
        const DEFAULT_BANNER = 'https://uompmspsrpswwofrrfwv.supabase.co/storage/v1/object/public/product-images/PainelConchas.jpeg';

        async function loadBannerConfig() {
            try {
                const { data, error } = await supabase
                    .from('site_config')
                    .select('*')
                    .eq('id', 'main')
                    .single();

                let imgUrl = DEFAULT_BANNER;
                let pos = '50% 50%';
                let size = 'cover';

                if (data) {
                    if (data.banner_image) imgUrl = data.banner_image;
                    if (data.banner_position) {
                        // Format: "x% y% / size" or just "x% y%"
                        const parts = data.banner_position.split('/');
                        pos = parts[0].trim();
                        if (parts.length > 1) {
                            size = parts[1].trim();
                        }
                    }
                }

                // Set Preview
                bannerPreviewDiv.style.backgroundImage = `url('${imgUrl}')`;
                bannerPreviewDiv.style.backgroundPosition = pos;
                bannerPreviewDiv.style.backgroundSize = size;

                // Set Inputs
                bannerPositionInput.value = size === 'cover' ? pos : `${pos} / ${size}`;
                posDisplay.textContent = `Config: ${bannerPositionInput.value}`;

                // Parse position for drag state
                const posParts = pos.split(' ');
                if (posParts.length >= 2) {
                    bannerDrag.initialX = parseFloat(posParts[0]);
                    bannerDrag.initialY = parseFloat(posParts[1]);
                } else if (pos === 'center') {
                    bannerDrag.initialX = 50;
                    bannerDrag.initialY = 50;
                }

                // Parse size for zoom slider
                if (size.includes('%')) {
                    const zoomVal = parseFloat(size);
                    bannerZoomInput.value = zoomVal;
                    zoomDisplay.textContent = `${zoomVal}%`;
                } else {
                    bannerZoomInput.value = 100;
                    zoomDisplay.textContent = '100% (Cover)';
                }

            } catch (e) {
                console.error('Erro ao carregar banner', e);
            }
        }

        function updateBannerConfigString() {
            const x = bannerDrag.initialX;
            const y = bannerDrag.initialY;
            const zoom = bannerZoomInput.value;

            const posStr = `${x}% ${y}%`;
            const sizeStr = zoom == 100 ? 'cover' : `${zoom}%`;

            bannerPreviewDiv.style.backgroundPosition = posStr;
            bannerPreviewDiv.style.backgroundSize = sizeStr;

            const configStr = `${posStr} / ${sizeStr}`;
            bannerPositionInput.value = configStr;
            posDisplay.textContent = `Config: ${configStr}`;
            zoomDisplay.textContent = sizeStr;
        }

        // Visual Editor Events
        // --- Mobile Menu Logic ---
        function toggleSidebar(show) {
            if (show === undefined) {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            } else if (show) {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('active');
            } else {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            }
        }

        mobileMenuBtn.addEventListener('click', () => toggleSidebar());
        sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

        bannerEditor.addEventListener('mousedown', (e) => {
            bannerDrag.active = true;
            updateDragPosition(e);
        });

        window.addEventListener('mousemove', (e) => {
            if (bannerDrag.active) {
                updateDragPosition(e);
            }
        });

        window.addEventListener('mouseup', () => {
            bannerDrag.active = false;
        });

        function updateDragPosition(e) {
            const rect = bannerEditor.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // Clamp
            x = Math.max(0, Math.min(x, rect.width));
            y = Math.max(0, Math.min(y, rect.height));

            const pctX = Math.round((x / rect.width) * 100);
            const pctY = Math.round((y / rect.height) * 100);

            bannerDrag.initialX = pctX;
            bannerDrag.initialY = pctY;

            updateBannerConfigString();
        }

        // Zoom Event
        bannerZoomInput.addEventListener('input', () => {
            updateBannerConfigString();
        });

        // Image change handler
        bannerImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bannerPreviewDiv.style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        });

        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBannerBtn.disabled = true;
            saveBannerBtn.textContent = 'Salvando...';
            bannerStatus.textContent = '';

            try {
                // Get current image URL from style (if not changed) or upload new
                let imageUrl = bannerPreviewDiv.style.backgroundImage.slice(5, -2); // remove url('...')
                // Clean up quotes if present
                if ((imageUrl.startsWith('"') && imageUrl.endsWith('"')) || (imageUrl.startsWith("'") && imageUrl.endsWith("'"))) {
                    imageUrl = imageUrl.slice(1, -1);
                }

                const file = bannerImageInput.files[0];

                if (file) {
                    const fileName = `banner-${Date.now()}-${file.name}`;
                    const { data, error } = await supabase.storage
                        .from('product-images')
                        .upload(fileName, file);

                    if (error) throw error;

                    const { data: publicData } = supabase.storage
                        .from('product-images')
                        .getPublicUrl(fileName);

                    imageUrl = publicData.publicUrl;
                }

                // Upsert config
                const { error } = await supabase
                    .from('site_config')
                    .upsert({
                        id: 'main',
                        banner_image: imageUrl,
                        banner_position: bannerPositionInput.value
                    });

                if (error) throw error;

                bannerStatus.textContent = 'Banner atualizado com sucesso!';
                bannerStatus.style.color = 'green';
            } catch (err) {
                console.error(err);
                bannerStatus.textContent = 'Erro ao salvar: ' + err.message;
                bannerStatus.style.color = 'red';
            } finally {
                saveBannerBtn.disabled = false;
                saveBannerBtn.textContent = 'Salvar Banner';
            }
        });


        // --- Product Logic ---
        async function loadProducts() {
            productList.innerHTML = 'Carregando...';
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('position', { ascending: true });

            if (error) {
                console.warn('Erro ao ordenar por position:', error);
                const { data: data2 } = await supabase.from('products').select('*');
                window.productsData = data2 || [];
            } else {
                window.productsData = data || [];
            }

            if (!window.productsData.length) {
                productList.innerHTML = '<p>Nenhum produto cadastrado.</p>';
                return;
            }

            renderProductList();
        }

        function renderProductList() {
            productList.innerHTML = '';
            window.productsData.forEach((p) => {
                // Ensure images is array
                let imgs = p.images;
                if (!Array.isArray(imgs)) {
                    imgs = p.image ? [p.image] : [];
                }
                const img = imgs.length > 0 ? imgs[0] : '';

                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = p.id;
                card.innerHTML = `
                    <img src="${img}">
                    <h3>${p.title}</h3>
                    <div class="price">${p.price}</div>
                    <div class="product-actions">
                        <button class="action-btn btn-edit" onclick="window.editProduct('${p.id}')">Editar</button>
                        <button class="action-btn btn-delete" onclick="window.deleteProduct('${p.id}')">Excluir</button>
                    </div>
                `;
                productList.appendChild(card);
            });

            // Initialize Sortable
            new Sortable(productList, {
                animation: 150,
                onEnd: async function (evt) {
                    // Update local array order
                    const itemEl = evt.item;
                    const newIndex = evt.newIndex;
                    const oldIndex = evt.oldIndex;

                    // Move item in array
                    const movedItem = window.productsData.splice(oldIndex, 1)[0];
                    window.productsData.splice(newIndex, 0, movedItem);

                    // Update all positions in DB
                    try {
                        const updates = window.productsData.map((p, idx) => ({
                            id: p.id,
                            position: idx
                        }));

                        for (const u of updates) {
                            await supabase.from('products').update({ position: u.position }).eq('id', u.id);
                        }
                    } catch (e) {
                        console.error('Erro ao reordenar', e);
                    }
                }
            });
        }

        // Edit
        window.editProduct = (id) => {
            const p = window.productsData.find(x => x.id === id);
            if (!p) return;

            document.getElementById('originalId').value = p.id;
            document.getElementById('id').value = p.id;
            document.getElementById('title').value = p.title;
            document.getElementById('price').value = p.price;
            document.getElementById('description').value = p.description;
            document.getElementById('features').value = (p.features || []).join(' | ');
            document.getElementById('autoplay_interval').value = p.autoplay_interval || 2000;

            // Robustly handle images
            let imgs = p.images;
            if (typeof imgs === 'string') {
                try {
                    imgs = JSON.parse(imgs);
                } catch (e) {
                    if (imgs.includes(',')) {
                        imgs = imgs.split(',').map(s => s.trim());
                    } else {
                        imgs = [imgs];
                    }
                }
            }

            if (!Array.isArray(imgs)) {
                imgs = p.image ? [p.image] : [];
            }

            currentImagesList = imgs;
            renderCurrentImages();

            formTitle.textContent = 'Editar Produto';
            submitBtn.textContent = 'Atualizar Produto';

            showProductForm();
        };

        window.deleteProduct = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;

            const { error } = await supabase.from('products').delete().eq('id', id);
            if (error) {
                alert('Erro ao excluir: ' + error.message);
            } else {
                loadProducts();
            }
        };

        function resetForm() {
            productForm.reset();
            document.getElementById('originalId').value = '';
            currentImagesList = [];
            renderCurrentImages();
            formTitle.textContent = 'Cadastrar Produto';
            submitBtn.textContent = 'Salvar Produto';
            status.textContent = '';
        }

        function renderCurrentImages() {
            currentImagesDiv.innerHTML = '';
            currentImagesList.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = 'img-preview-item';
                div.innerHTML = `
                    <img src="${url}">
                    <button type="button" class="btn-remove-img" onclick="removeImage(${index})">x</button>
                `;
                currentImagesDiv.appendChild(div);
            });
        }

        window.removeImage = (index) => {
            currentImagesList.splice(index, 1);
            renderCurrentImages();
        };

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';
            status.textContent = '';

            const originalId = document.getElementById('originalId').value;
            const id = document.getElementById('id').value;
            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value;
            const features = document.getElementById('features').value.split('|').map(s => s.trim()).filter(Boolean);
            const autoplay_interval = parseInt(document.getElementById('autoplay_interval').value) || 0;
            const imageFiles = document.getElementById('image').files;

            try {
                // Upload new images
                const newImageUrls = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const fileName = `${id}-${Date.now()}-${i}`;
                    const { data, error } = await supabase.storage
                        .from('product-images')
                        .upload(fileName, file);

                    if (error) throw error;

                    const { data: publicData } = supabase.storage
                        .from('product-images')
                        .getPublicUrl(fileName);

                    newImageUrls.push(publicData.publicUrl);
                }

                // Combine with existing images
                const finalImages = [...currentImagesList, ...newImageUrls];
                const mainImage = finalImages.length > 0 ? finalImages[0] : null;

                const productData = {
                    id,
                    title,
                    price,
                    description,
                    features,
                    autoplay_interval,
                    images: finalImages,
                    image: mainImage // Keep legacy field for compatibility
                };

                let error;
                if (originalId) {
                    // Update
                    const { error: err } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', originalId);
                    error = err;
                } else {
                    // Insert
                    // Get max position
                    const { data: maxPosData } = await supabase.from('products').select('position').order('position', { ascending: false }).limit(1);
                    const nextPos = (maxPosData && maxPosData.length > 0) ? (maxPosData[0].position + 1) : 0;
                    productData.position = nextPos;

                    const { error: err } = await supabase
                        .from('products')
                        .insert([productData]);
                    error = err;
                }

                if (error) throw error;

                status.textContent = 'Produto salvo com sucesso!';
                status.style.color = 'green';
                setTimeout(() => {
                    hideProductForm();
                    loadProducts();
                }, 1000);

            } catch (err) {
                console.error(err);
                status.textContent = 'Erro: ' + err.message;
                status.style.color = 'red';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalId ? 'Atualizar Produto' : 'Salvar Produto';
            }
        });

        // Init
        checkUser();

    </script>
</body>

</html>